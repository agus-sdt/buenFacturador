{% extends "base.html" %}

{% block title %}Editar Factura {{ factura.numero_factura }} - Sistema de Facturación{% endblock %}

{% block page_title %}Editar Factura{% endblock %}

{% block breadcrumb %}
{{ super() }}
<li class="breadcrumb-item"><a href="{{ url_for('facturas.lista_facturas') }}">Facturas</a></li>
<li class="breadcrumb-item"><a href="{{ url_for('facturas.ver_factura', id=factura.id_factura) }}">{{ factura.numero_factura }}</a></li>
<li class="breadcrumb-item active">Editar</li>
{% endblock %}

{% block content %}
<form method="POST" action="{{ url_for('facturas.editar_factura', id=factura.id_factura) }}" id="factura-form">
    <div class="row">
        <div class="col-md-8">
            <div class="card card-warning">
                <div class="card-header">
                    <h3 class="card-title">
                        <i class="fas fa-edit"></i> Editando Factura {{ factura.numero_factura }}
                    </h3>
                    <div class="card-tools">
                        <span class="badge badge-warning">{{ factura.estado|title }}</span>
                    </div>
                </div>
                <div class="card-body">
                    <div class="alert alert-warning">
                        <i class="fas fa-exclamation-triangle"></i>
                        <strong>Atención:</strong> Al editar la factura, el stock de productos se ajustará
                        automáticamente.
                    </div>

                    <div class="row">
                        <div class="col-md-6">
                            <div class="form-group">
                                <label for="id_cliente">Cliente <span class="text-danger">*</span></label>
                                <select class="form-control" id="id_cliente" name="id_cliente" required>
                                    <option value="">Seleccionar cliente...</option>
                                    {% for cliente in clientes %}
                                    <option value="{{ cliente.id_cliente }}" {% if
                                        cliente.id_cliente==factura.id_cliente %}selected{% endif %}>
                                        {{ cliente.nombre }}
                                        {% if cliente.email %} - {{ cliente.email }}{% endif %}
                                    </option>
                                    {% endfor %}
                                </select>
                                <small class="form-text text-muted">Cliente original: {{ factura.cliente.nombre
                                    }}</small>
                            </div>
                        </div>

                        <div class="col-md-6">
                            <div class="form-group">
                                <label>Número de Factura</label>
                                <input type="text" class="form-control" value="{{ factura.numero_factura }}" disabled>
                                <small class="form-text text-muted">El número no se puede modificar</small>
                            </div>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-6">
                            <div class="form-group">
                                <label>Fecha</label>
                                <input type="text" class="form-control" value="{{ factura.fecha.strftime('%d/%m/%Y') if factura.fecha else '' }}
" disabled>
                                <small class="form-text text-muted">Fecha original de creación</small>
                            </div>
                        </div>

                        <div class="col-md-6">
                            <div class="form-group">
                                <label>Estado Actual</label>
                                <input type="text" class="form-control" value="{{ factura.estado|title }}" disabled>
                                <small class="form-text text-muted">Cambiar estado desde la vista de detalle</small>
                            </div>
                        </div>
                    </div>

                    <div class="form-group">
                        <label for="observaciones">Observaciones</label>
                        <textarea class="form-control" id="observaciones" name="observaciones" rows="3"
                            placeholder="Observaciones adicionales para la factura (opcional)">{{ factura.observaciones or '' }}</textarea>
                    </div>
                </div>
            </div>

            <div class="card card-success">
                <div class="card-header">
                    <h3 class="card-title">
                        <i class="fas fa-shopping-cart"></i> Productos
                    </h3>
                    <div class="card-tools">
                        <button type="button" class="btn btn-success btn-sm" id="agregar-producto">
                            <i class="fas fa-plus"></i> Agregar Producto
                        </button>
                    </div>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-bordered" id="productos-table">
                            <thead>
                                <tr>
                                    <th width="25%">Producto</th>
                                    <th width="20%">Descripción</th>
                                    <th width="15%">Precio Unit.</th>
                                    <th width="15%">Cantidad</th>
                                    <th width="15%">Subtotal</th>
                                    <th width="10%">Acciones</th>
                                </tr>
                            </thead>
                            <tbody id="productos-tbody">
                                {% for detalle in factura.detalles %}
                                <tr class="producto-row">
                                    <td>
                                        <select class="form-control producto-select" name="id_producto[]" required>
                                            <option value="">Seleccionar...</option>
                                            {% for producto in productos %}
                                            <option value="{{ producto.id_producto }}"
                                                data-precio="{{ producto.precio }}"
                                                data-stock="{{ (producto.stock or 0) + (detalle.cantidad if detalle.id_producto == producto.id_producto else 0) }}"
                                                data-descripcion="{{ producto.descripcion }}" {% if
                                                detalle.id_producto==producto.id_producto %}selected{% endif %}>
                                                {{ producto.descripcion }} (Stock: {{ producto.stock + (detalle.cantidad
                                                if detalle.id_producto == producto.id_producto else 0) }})
                                            </option>
                                            {% endfor %}
                                        </select>
                                    </td>
                                    <td>
                                        <input type="text" class="form-control descripcion-input"
                                            value="{{ detalle.descripcion_producto }}" readonly>
                                    </td>
                                    <td>
                                        <input type="number" class="form-control precio-input" name="precio[]"
                                            step="0.01" min="0" value="{{ detalle.precio_unitario }}" required>
                                    </td>
                                    <td>
                                        <input type="number" class="form-control cantidad-input" name="cantidad[]"
                                            min="1" value="{{ detalle.cantidad }}" required>
                                    </td>
                                    <td>
                                        <input type="text" class="form-control subtotal-input" value="${{ "
                                            %.2f"|format(detalle.subtotal) }}" readonly>
                                    </td>
                                    <td>
                                        <button type="button" class="btn btn-danger btn-sm eliminar-producto"
                                            title="Eliminar">
                                            <i class="fas fa-trash"></i>
                                        </button>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>

                    <div class="text-center py-3" id="sin-productos" style="display: none;">
                        <i class="fas fa-shopping-cart fa-3x text-muted"></i>
                        <p class="text-muted mt-2">No hay productos agregados</p>
                        <button type="button" class="btn btn-success" id="agregar-primer-producto">
                            <i class="fas fa-plus"></i> Agregar Primer Producto
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-md-4">
            <div class="card card-info">
                <div class="card-header">
                    <h3 class="card-title">Resumen</h3>
                </div>
                <div class="card-body">
                    <table class="table">
                        <tr>
                            <td><strong>Subtotal:</strong></td>
                            <td class="text-right"><span id="resumen-subtotal">${{ "%.2f"|format(factura.subtotal)
                                    }}</span></td>
                        </tr>
                        <tr>
                            <td><strong>IVA (21%):</strong></td>
                            <td class="text-right"><span id="resumen-iva">${{ "%.2f"|format(factura.iva) }}</span></td>
                        </tr>
                        <tr class="bg-info">
                            <td><strong>TOTAL:</strong></td>
                            <td class="text-right"><strong><span id="resumen-total">${{ "%.2f"|format(factura.total)
                                        }}</span></strong></td>
                        </tr>
                    </table>
                </div>
                <div class="card-footer">
                    <button type="submit" class="btn btn-warning btn-block">
                        <i class="fas fa-save"></i> Actualizar Factura
                    </button>
                    <a href="{{ url_for('facturas.ver_factura', id=factura.id_factura) }}"
                        class="btn btn-info btn-block mt-2">
                        <i class="fas fa-eye"></i> Ver Factura
                    </a>
                    <a href="{{ url_for('facturas.lista_facturas') }}" class="btn btn-secondary btn-block mt-2">
                        <i class="fas fa-times"></i> Cancelar
                    </a>
                </div>
            </div>

            <div class="card card-light">
                <div class="card-header">
                    <h3 class="card-title">Información Original</h3>
                </div>
                <div class="card-body">
                    <dl class="row">
                        <dt class="col-sm-6">Número:</dt>
                        <dd class="col-sm-6">{{ factura.numero_factura }}</dd>

                        <dt class="col-sm-6">Fecha:</dt>
                        <dd class="col-sm-6">{{ factura.fecha.strftime('%d/%m/%Y') if factura.fecha else '' }}</dd>

                        <dt class="col-sm-6">Cliente:</dt>
                        <dd class="col-sm-6">{{ factura.cliente.nombre }}</dd>

                        <dt class="col-sm-6">Total Original:</dt>
                        <dd class="col-sm-6">${{ "%.2f"|format(factura.total) }}</dd>

                        <dt class="col-sm-6">Estado:</dt>
                        <dd class="col-sm-6">
                            <span class="badge badge-warning">{{ factura.estado|title }}</span>
                        </dd>
                    </dl>
                </div>
            </div>

            <div class="card card-warning">
                <div class="card-header">
                    <h3 class="card-title">Ayuda</h3>
                </div>
                <div class="card-body">
                    <div class="alert alert-warning">
                        <i class="fas fa-exclamation-triangle"></i>
                        <strong>Importante:</strong> Solo se pueden editar facturas con estado "Pendiente".
                    </div>

                    <p><strong>Al editar:</strong></p>
                    <ul>
                        <li>Se restaura el stock original</li>
                        <li>Se aplican los nuevos cambios</li>
                        <li>Se recalculan los totales</li>
                        <li>Se ajusta el stock final</li>
                    </ul>

                    <div class="alert alert-info mt-3">
                        <i class="fas fa-info-circle"></i>
                        Productos con stock disponible: {{ productos|length }}
                    </div>
                </div>
            </div>
        </div>
    </div>
</form>

<template id="producto-row-template">
    <tr class="producto-row">
        <td>
            <select class="form-control producto-select" name="id_producto[]" required>
                <option value="">Seleccionar...</option>
                {% for producto in productos %}
                <option value="{{ producto.id_producto }}" data-precio="{{ producto.precio }}"
                    data-stock="{{ producto.stock }}" data-descripcion="{{ producto.descripcion }}">
                    {{ producto.descripcion }} (Stock: {{ producto.stock }})
                </option>
                {% endfor %}
            </select>
        </td>
        <td>
            <input type="text" class="form-control descripcion-input" readonly>
        </td>
        <td>
            <input type="number" class="form-control precio-input" name="precio[]" step="0.01" min="0" required>
        </td>
        <td>
            <input type="number" class="form-control cantidad-input" name="cantidad[]" min="1" required>
        </td>
        <td>
            <input type="text" class="form-control subtotal-input" readonly>
        </td>
        <td>
            <button type="button" class="btn btn-danger btn-sm eliminar-producto" title="Eliminar">
                <i class="fas fa-trash"></i>
            </button>
        </td>
    </tr>
</template>
{% endblock %}

{% block extra_js %}
<script>
    $(document).ready(function () {
        let contadorFilas = parseInt("{{ factura.detalles|length|default(0, true) }}");

        calcularResumen();

        function agregarProducto() {
            const template = document.getElementById('producto-row-template');
            const clone = template.content.cloneNode(true);

            document.getElementById('productos-tbody').appendChild(clone);
            contadorFilas++;

            $('#sin-productos').hide();

            configurarEventosFila($('#productos-tbody tr:last'));

            $('#productos-tbody tr:last .producto-select').focus();
        }

        function configurarEventosFila($fila) {
            $fila.find('.producto-select').on('change', function () {
                const $option = $(this).find('option:selected');
                const $row = $(this).closest('tr');

                if ($option.val()) {
                    const precio = parseFloat($option.data('precio'));
                    const descripcion = $option.data('descripcion');
                    const stock = parseInt($option.data('stock'));

                    $row.find('.descripcion-input').val(descripcion);
                    $row.find('.precio-input').val(precio.toFixed(2));
                    $row.find('.cantidad-input').attr('max', stock).val(1);

                    calcularSubtotalFila($row);
                } else {
                    limpiarFila($row);
                }
            });

            $fila.find('.cantidad-input, .precio-input').on('input', function () {
                const $row = $(this).closest('tr');
                calcularSubtotalFila($row);
            });

            $fila.find('.eliminar-producto').on('click', function () {
                const $row = $(this).closest('tr');
                $row.remove();
                contadorFilas--;

                if (contadorFilas === 0) {
                    $('#sin-productos').show();
                }

                setTimeout(function () {
                    calcularResumen();
                }, 100);
            });
        }

        function calcularSubtotalFila($fila) {
            const precio = parseFloat($fila.find('.precio-input').val()) || 0;
            const cantidad = parseInt($fila.find('.cantidad-input').val()) || 0;
            const subtotal = precio * cantidad;

            $fila.find('.subtotal-input').val('$' + subtotal.toFixed(2));

            calcularResumen();
        }

        function limpiarFila($fila) {
            $fila.find('.descripcion-input').val('');
            $fila.find('.precio-input').val('');
            $fila.find('.cantidad-input').val('');
            $fila.find('.subtotal-input').val('');
            calcularResumen();
        }

        function calcularResumen() {
            let subtotal = 0;

            $('.producto-row').each(function () {
                const precio = parseFloat($(this).find('.precio-input').val()) || 0;
                const cantidad = parseInt($(this).find('.cantidad-input').val()) || 0;
                subtotal += precio * cantidad;
            });

            const iva = subtotal * 0.21;
            const total = subtotal + iva;

            $('#resumen-subtotal').text('$' + subtotal.toFixed(2));
            $('#resumen-iva').text('$' + iva.toFixed(2));
            $('#resumen-total').text('$' + total.toFixed(2));
        }

        $('.producto-row').each(function () {
            configurarEventosFila($(this));
        });

        $('#agregar-producto, #agregar-primer-producto').on('click', agregarProducto);

        $('#factura-form').on('submit', function (e) {
            if (contadorFilas === 0) {
                alert('Debe tener al menos un producto');
                e.preventDefault();
                return false;
            }

            if (!$('#id_cliente').val()) {
                alert('Debe seleccionar un cliente');
                $('#id_cliente').focus();
                e.preventDefault();
                return false;
            }

            let valido = true;
            $('.producto-row').each(function () {
                const producto = $(this).find('.producto-select').val();
                const cantidad = $(this).find('.cantidad-input').val();
                const precio = $(this).find('.precio-input').val();

                if (!producto || !cantidad || !precio) {
                    valido = false;
                    return false;
                }
            });

            if (!valido) {
                alert('Complete todos los campos de productos');
                e.preventDefault();
                return false;
            }

            const confirmacion = confirm(
                '¿Confirma los cambios en la factura?\n\n' +
                'Se actualizarán:\n' +
                '- Los productos y cantidades\n' +
                '- Los precios y totales\n' +
                '- El stock de productos\n\n' +
                '¿Continuar?'
            );

            if (!confirmacion) {
                e.preventDefault();
                return false;
            }

            $('button[type="submit"]').html('<i class="fas fa-spinner fa-spin"></i> Actualizando...').prop('disabled', true);
        });

        if (contadorFilas === 0) {
            $('#sin-productos').show();
        }
    });
</script>
{% endblock %}